--[[
    UNPATCHABOMB [ULTIMATE EDITION v7.2 - BLACKLIST UPDATE]
    - NEW: Blacklist support for "Last Letter" and "Word Bomb".
    - NEW: Dynamic loadstring fetching for remote blacklists.
    - NEW: UI expanded to accommodate blacklist toggles.
]]--

--------------------------------------------------------------------------------
-- 0. CONFIGURATION & BLACKLIST URLS
--------------------------------------------------------------------------------
-- PUT YOUR LINKS HERE:
local LAST_LETTER_BLACKLIST_URL = "https://your-link-here.com/last_letter.lua"
local WORD_BOMB_BLACKLIST_URL   = "https://your-link-here.com/word_bomb.lua"

local DictionaryURLs = {
    "https://raw.githubusercontent.com/amongYou12/wordBomb/refs/heads/main/enable1.txt",
    "https://gist.githubusercontent.com/letterpressfan/4145939/raw/4ca79142f49ce9ac8758cf3146ce14aa89b217cd/in-lp1.1-but-not-csw12.txt",
    "https://raw.githubusercontent.com/gangulwar/JKLM-Bomb-Party-BOT/refs/heads/main/dictionary.txt",
    "https://raw.githubusercontent.com/dwyl/english-words/refs/heads/master/words_alpha.txt",
    "https://raw.githubusercontent.com/amongYou12/wordBomb/refs/heads/main/Extra.txt"
}

--------------------------------------------------------------------------------
-- 1. STATE & TABLES
--------------------------------------------------------------------------------
local LL_Enabled = false
local WB_Enabled = false
local LL_Blacklist = {}
local WB_Blacklist = {}

local SAVED_WORDS_LIST = {}
local ALL_WORDS = {}

local TYPING_SETTINGS = {
    StartSlowDelay = {0.055, 0.095}, 
    BaseSpeed = {0.055, 0.075}, 
    HesitationChance = 0.65,
    HesitationDelay = {0.085, 0.12}, 
    SubmitDelay = {0.05, 0.1}, 
    TypoChance = 0.35, 
    BackspaceSpeed = {0.07, 0.13} 
}

--------------------------------------------------------------------------------
-- 2. CORE UTILITIES
--------------------------------------------------------------------------------
local GlobalEnv = (getgenv and getgenv()) or _G
if not GlobalEnv._Unpatchabomb_History_Final then GlobalEnv._Unpatchabomb_History_Final = {} end

local function CheckHistory(word) return GlobalEnv._Unpatchabomb_History_Final[word:lower()] end
local function AddToHistory(word) GlobalEnv._Unpatchabomb_History_Final[word:lower()] = true end
local function ClearHistory() GlobalEnv._Unpatchabomb_History_Final = {} end

local function SanitizeWord(str) return str:gsub("%s+", ""):gsub("[^a-zA-Z0-9%-]", "") end

-- Function to fetch and load a blacklist via loadstring
local function LoadBlacklist(url, targetTable)
    local success, content = pcall(function() return game:HttpGet(url) end)
    if success then
        local func, err = loadstring(content)
        if func then
            local data = func()
            if type(data) == "table" then
                for _, word in ipairs(data) do
                    targetTable[word:lower()] = true
                end
                return true
            end
        end
    end
    return false
end

--------------------------------------------------------------------------------
-- 3. UI CONSTRUCTION (Expanded for Row 3)
--------------------------------------------------------------------------------
local CoreGui = game:GetService("CoreGui")
local ParentTarget = (gethui and gethui()) or CoreGui:FindFirstChild("RobloxGui") or CoreGui
if ParentTarget:FindFirstChild("Unpatchabomb") then ParentTarget.Unpatchabomb:Destroy() end

local Unpatchabomb = Instance.new("ScreenGui"); Unpatchabomb.Name = "Unpatchabomb"; Unpatchabomb.Parent = ParentTarget; Unpatchabomb.ResetOnSpawn = false
local MainFrame = Instance.new("Frame"); MainFrame.Name = "MainFrame"; MainFrame.Parent = Unpatchabomb; MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25); MainFrame.Position = UDim2.new(0.5, -160, 0.5, -120); MainFrame.Size = UDim2.new(0, 320, 0, 240); MainFrame.BorderSizePixel = 0
local MainCorner = Instance.new("UICorner"); MainCorner.CornerRadius = UDim.new(0, 8); MainCorner.Parent = MainFrame

local TopBar = Instance.new("Frame"); TopBar.Name = "TopBar"; TopBar.Parent = MainFrame; TopBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35); TopBar.Size = UDim2.new(1, 0, 0, 32); TopBar.BorderSizePixel = 0
local TopBarCorner = Instance.new("UICorner"); TopBarCorner.CornerRadius = UDim.new(0, 8); TopBarCorner.Parent = TopBar
local Title = Instance.new("TextLabel"); Title.Parent = TopBar; Title.BackgroundTransparency = 1; Title.Position = UDim2.new(0, 12, 0, 0); Title.Size = UDim2.new(0.5, 0, 1, 0); Title.Font = Enum.Font.GothamBold; Title.Text = "UNPATCHABOMB v7.2"; Title.TextColor3 = Color3.fromRGB(255, 255, 255); Title.TextSize = 14; Title.TextXAlignment = Enum.TextXAlignment.Left

local WordText = Instance.new("TextLabel"); WordText.Name = "Status"; WordText.Parent = MainFrame; WordText.BackgroundTransparency = 1; WordText.Position = UDim2.new(0, 0, 0.15, 0); WordText.Size = UDim2.new(1, 0, 0.10, 0); WordText.Font = Enum.Font.GothamMedium; WordText.Text = "Loading..."; WordText.TextColor3 = Color3.fromRGB(150, 150, 150); WordText.TextSize = 13

-- Standard Elements (Dictionary Loading)
task.spawn(function()
    local count = 0
    for _, url in ipairs(DictionaryURLs) do
        local s, content = pcall(function() return game:HttpGet(url) end)
        if s then for line in content:gmatch("[^\r\n]+") do table.insert(ALL_WORDS, line:match("^%s*(.-)%s*$")) count = count + 1 end end
    end
    WordText.Text = "Loaded " .. count .. " Words"
end)

local LetterBox = Instance.new("TextBox"); LetterBox.Name = "Input"; LetterBox.Parent = MainFrame; LetterBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40); LetterBox.Position = UDim2.new(0.05, 0, 0.28, 0); LetterBox.Size = UDim2.new(0.65, 0, 0.15, 0); LetterBox.Font = Enum.Font.GothamBold; LetterBox.PlaceholderText = "Letters..."; LetterBox.Text = ""; LetterBox.TextColor3 = Color3.fromRGB(255, 255, 255); LetterBox.TextSize = 14
local BoxCorner = Instance.new("UICorner"); BoxCorner.Parent = LetterBox

local RerunButton = Instance.new("TextButton"); RerunButton.Parent = MainFrame; RerunButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113); RerunButton.Position = UDim2.new(0.73, 0, 0.28, 0); RerunButton.Size = UDim2.new(0.22, 0, 0.15, 0); RerunButton.Font = Enum.Font.GothamBold; RerunButton.Text = "â–¶"; RerunButton.TextColor3 = Color3.fromRGB(25, 25, 25); RerunButton.TextSize = 18
local RunCorner = Instance.new("UICorner"); RunCorner.Parent = RerunButton

local function CreateBtn(name, text, pos, size, color)
    local btn = Instance.new("TextButton"); btn.Name = name; btn.Parent = MainFrame
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40); btn.Position = pos; btn.Size = size; btn.Font = Enum.Font.GothamBold; btn.Text = text; btn.TextColor3 = color; btn.TextSize = 9
    local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0, 6); c.Parent = btn
    return btn
end

-- ROW 1: Toggles
local FirstBtn = CreateBtn("First", "First: OFF", UDim2.new(0.05, 0, 0.46, 0), UDim2.new(0.28, 0, 0.10, 0), Color3.new(0.6,0.6,0.6))
local ShortBtn = CreateBtn("Short", "Short: OFF", UDim2.new(0.36, 0, 0.46, 0), UDim2.new(0.28, 0, 0.10, 0), Color3.new(0.6,0.6,0.6))
local FlexBtn  = CreateBtn("Flex", "Flex: OFF", UDim2.new(0.67, 0, 0.46, 0), UDim2.new(0.28, 0, 0.10, 0), Color3.new(0.6,0.6,0.6))

-- ROW 2: NEW BLACKLIST BUTTONS
local LLBtn = CreateBtn("LLBlacklist", "Last Letter Blacklist", UDim2.new(0.05, 0, 0.58, 0), UDim2.new(0.44, 0, 0.12, 0), Color3.new(0.6,0.6,0.6))
local WBBtn = CreateBtn("WBBlacklist", "Word Bomb Blacklist", UDim2.new(0.51, 0, 0.58, 0), UDim2.new(0.44, 0, 0.12, 0), Color3.new(0.6,0.6,0.6))

-- ROW 3: Save & List
local SaveBtn = CreateBtn("Save", "Save/Clear Word", UDim2.new(0.05, 0, 0.72, 0), UDim2.new(0.44, 0, 0.12, 0), Color3.fromRGB(230, 126, 34))
local ListBtn = CreateBtn("View", "View Saved List", UDim2.new(0.51, 0, 0.72, 0), UDim2.new(0.44, 0, 0.12, 0), Color3.fromRGB(155, 89, 182))

-- Reset
local ResetBtn = CreateBtn("Reset", "Reset History", UDim2.new(0.05, 0, 0.86, 0), UDim2.new(0.9, 0, 0.08, 0), Color3.fromRGB(231, 76, 60))

--------------------------------------------------------------------------------
-- 4. SEARCH & FILTER ENGINE
--------------------------------------------------------------------------------
local function IsBlacklisted(word)
    local w = word:lower()
    if LL_Enabled and LL_Blacklist[w] then return true end
    if WB_Enabled and WB_Blacklist[w] then return true end
    return false
end

local function IDA_PerformSearch()
    local input = SanitizeWord(LetterBox.Text):lower()
    if input == "" then return end
    
    WordText.Text = "Searching..."
    task.spawn(function()
        local found = nil
        for _, v in ipairs(ALL_WORDS) do
            local cleanV = SanitizeWord(v)
            if cleanV:lower():find(input, 1, true) then
                -- CHECK HISTORY AND BLACKLISTS
                if not CheckHistory(cleanV) and not IsBlacklisted(cleanV) then
                    found = cleanV
                    break
                end
            end
        end

        if found then
            WordText.Text = "Suggesting: " .. found
            WordText.TextColor3 = Color3.fromRGB(0, 200, 255)
            -- Trigger typing logic here (omitted for brevity, same as previous versions)
        else
            WordText.Text = "No clean words found!"
            WordText.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end)
end

--------------------------------------------------------------------------------
-- 5. BUTTON LOGIC
--------------------------------------------------------------------------------
LLBtn.MouseButton1Click:Connect(function()
    LL_Enabled = not LL_Enabled
    if LL_Enabled and next(LL_Blacklist) == nil then
        WordText.Text = "Loading Last Letter Blacklist..."
        if LoadBlacklist(LAST_LETTER_BLACKLIST_URL, LL_Blacklist) then
            WordText.Text = "LL Blacklist Loaded!"
        else
            WordText.Text = "LL Blacklist Load Failed!"
        end
    end
    LLBtn.Text = LL_Enabled and "LL Blacklist: ON" or "Last Letter Blacklist"
    LLBtn.TextColor3 = LL_Enabled and Color3.new(1, 0.5, 0) or Color3.new(0.6,0.6,0.6)
end)

WBBtn.MouseButton1Click:Connect(function()
    WB_Enabled = not WB_Enabled
    if WB_Enabled and next(WB_Blacklist) == nil then
        WordText.Text = "Loading Word Bomb Blacklist..."
        if LoadBlacklist(WORD_BOMB_BLACKLIST_URL, WB_Blacklist) then
            WordText.Text = "WB Blacklist Loaded!"
        else
            WordText.Text = "WB Blacklist Load Failed!"
        end
    end
    WBBtn.Text = WB_Enabled and "WB Blacklist: ON" or "Word Bomb Blacklist"
    WBBtn.TextColor3 = WB_Enabled and Color3.new(1, 0.2, 0.2) or Color3.new(0.6,0.6,0.6)
end)

RerunButton.MouseButton1Click:Connect(IDA_PerformSearch)
ResetBtn.MouseButton1Click:Connect(function() ClearHistory(); WordText.Text = "History Cleared" end)
